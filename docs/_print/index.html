<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.80.0" /><link rel="canonical" type="text/html" href="/docs/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Documentation | Opta</title><meta property="og:title" content="Documentation" />
<meta property="og:description" content="Documentation for the Runx products." />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/" />
<meta property="og:site_name" content="Opta" />
<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="Documentation for the Runx products.">
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content="Documentation for the Runx products."/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-188763285-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<link rel="preload" href="/scss/main.min.a4f4923899f9878a84cfd83f594a4cec69ffb2fa0e75cb0d777edae060863ead.css" as="style">
<link href="/scss/main.min.a4f4923899f9878a84cfd83f594a4cec69ffb2fa0e75cb0d777edae060863ead.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>


<script type="text/javascript">
    (function(e,t){var n=e.amplitude||{_q:[],_iq:{}};var r=t.createElement("script")
    ;r.type="text/javascript"
    ;r.integrity="sha384-girahbTbYZ9tT03PWWj0mEVgyxtZoyDF9KVZdL+R53PP5wCY0PiVUKq0jeRlMx9M"
    ;r.crossOrigin="anonymous";r.async=true
    ;r.src="https://cdn.amplitude.com/libs/amplitude-7.2.1-min.gz.js"
    ;r.onload=function(){if(!e.amplitude.runQueuedFunctions){
        console.log("[Amplitude] Error: could not load SDK")}}
    ;var i=t.getElementsByTagName("script")[0];i.parentNode.insertBefore(r,i)
    ;function s(e,t){e.prototype[t]=function(){
        this._q.push([t].concat(Array.prototype.slice.call(arguments,0)));return this}}
        var o=function(){this._q=[];return this}
        ;var a=["add","append","clearAll","prepend","set","setOnce","unset"]
        ;for(var u=0;u<a.length;u++){s(o,a[u])}n.Identify=o;var c=function(){this._q=[]
            ;return this}
        ;var l=["setProductId","setQuantity","setPrice","setRevenueType","setEventProperties"]
        ;for(var p=0;p<l.length;p++){s(c,l[p])}n.Revenue=c
        ;var d=["init","logEvent","logRevenue","setUserId","setUserProperties","setOptOut","setVersionName","setDomain","setDeviceId", "enableTracking", "setGlobalUserProperties","identify","clearUserProperties","setGroup","logRevenueV2","regenerateDeviceId","groupIdentify","onInit","logEventWithTimestamp","logEventWithGroups","setSessionId","resetSessionId"]
        ;function v(e){function t(t){e[t]=function(){
            e._q.push([t].concat(Array.prototype.slice.call(arguments,0)))}}
            for(var n=0;n<d.length;n++){t(d[n])}}v(n);n.getInstance=function(e){
            e=(!e||e.length===0?"$default_instance":e).toLowerCase()
            ;if(!n._iq.hasOwnProperty(e)){n._iq[e]={_q:[]};v(n._iq[e])}return n._iq[e]}
        ;e.amplitude=n})(window,document);

    amplitude.getInstance().init("3c2edcd34808a6431499f4cd9b034e34");

    amplitude.getInstance().logEvent("Viewed " + document.title + " Page", {
        url: window.location.href,
    });
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />



  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="113" height="32" viewBox="0 0 113 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.4425 25.3675 7.86982 20.2459C7.71992 20.2625 7.49507 20.2709 7.19527 20.2709H3.24786V25.3675H0V7.87903H7.19527C8.71093 7.87903 10.0267 8.12886 11.1427 8.62854 12.2753 9.12821 13.1414 9.8444 13.741 10.7771 14.3406 11.7098 14.6404 12.8174 14.6404 14.0999 14.6404 15.4157 14.3156 16.5483 13.666 17.4977 13.0331 18.4471 12.117 19.1549 10.9178 19.6213L14.9402 25.3675H11.4425zM11.3675 14.0999C11.3675 12.984 11.0011 12.1262 10.2682 11.5266 9.53539 10.927 8.4611 10.6272 7.04536 10.6272H3.24786v6.9704H7.04536C8.4611 17.5976 9.53539 17.2978 10.2682 16.6982 11.0011 16.082 11.3675 15.2159 11.3675 14.0999z" fill="#fff"/><path d="M29.7915 25.6174C27.3765 25.6174 25.4944 24.9428 24.1452 23.5937 22.7961 22.2279 22.1216 20.2792 22.1216 17.7475V7.87903H25.3694V17.6226C25.3694 21.0537 26.8518 22.7692 29.8165 22.7692 32.7646 22.7692 34.2386 21.0537 34.2386 17.6226V7.87903H37.4365V17.7475C37.4365 20.2792 36.7619 22.2279 35.4128 23.5937 34.0804 24.9428 32.2066 25.6174 29.7915 25.6174z" fill="#fff"/><path d="M61.5222 7.87903V25.3675H58.849L49.2053 13.5253V25.3675H45.9824V7.87903H48.6557L58.2993 19.7212V7.87903H61.5222z" fill="#fff"/><path d="M96.8415 25.3675 93.2189 19.9461 89.6463 25.3675H84L90.3708 16.5233 84.2748 7.87903H89.8461L93.3438 12.9257 96.7916 7.87903H102.138L96.0421 16.3235 102.538 25.3675H96.8415z" fill="#fff"/><path d="M107.453 32V30.5299H111.248V1.47008H107.453V0H112.957V32H107.453z" fill="#fe794f"/><path d="M72.5.0H78.0043V1.47009H74.2094V30.5299H78.0043V32H72.5V0z" fill="#fe794f"/></svg></span><span class="text-uppercase font-weight-bold">Opta</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a  class="nav-link active" href="/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-6e17e09fffc1050f46600282def85180">Overview</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-93aadc1aba179e6928539400a09b9e4e">Getting Started</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-6121397c9c1b82e0a74996f89313317c">Installation</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-8dbd4e302cd86a4d0f71f71ce3b300de">Tutorials</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-f107a9a5510ab74922b9a96e5ca94e5e">Continuous Deployment</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-83887ce2e0d6dbc08b4950ccb6e53c2c">Datadog Integration</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-5b96ef224df2cb76031f57bc78e2a4e2">Debugging</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-9d0b9641c9f6229bb5bedf0bcd2431a9">IAM Guidance</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-fc48c3d786e14f954240ac60661342b3">Ingress</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-10de6b7200433cebbfbebcaa1583a5c0">Secrets</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-bec94d1629f08bf2950648ea6d1cd59d">Modues reference</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-e9dfe91c9afb5ff49c25d4272db6709a">Environment modules</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1.1: <a href="#pg-8b65a7f9c654579631b4e0819aa048df">AWS environment modules</a></li>


    
  
    
    
	
<li>5.1.2: <a href="#pg-b02d26f6c20395131bdf4246898f743a">GCP environment modules</a></li>


    
  
    
    
	
<li>5.1.3: <a href="#pg-3525fa571dc1c25f855af7e3f2060b89">Cloud agnostic environment modules</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5.2: <a href="#pg-17f62f7e9a70bad68895e6447344b83a">Service modules</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.2.1: <a href="#pg-d13b5dc21fdb391688377e7ca5945001">AWS service modules</a></li>


    
  
    
    
	
<li>5.2.2: <a href="#pg-0f95dcc211c00d06f7f821a5c6acfcf1">GCP service modules</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-23695faee9f53cc21616fd61b8186a04">Architecture</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>Table of Contents</p>

</div>

<p>Here you can find all the documentations for the Opta CLI.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6e17e09fffc1050f46600282def85180">1 - Overview</h1>
    <div class="lead">What is Opta?</div>
	<p>Opta, is a cloud infrastructure management tool specifically designed to reduce
complexity and improve iteration speed.</p>
<p>Opta enables you to set up infra on your AWS/GCP account/project via high-level config files
(that describe microservices and databases) and low level details like access
permissions, network and secret management are handled automatically.</p>
<p>This way setting up a new environment takes &lt;30min and setting up a new service
takes &lt;10min. All without any Infra/AWS/GCP/Kubernetes expertise PLUS you get an
industry standard setup (including monitoring) from day 1.</p>
<h2 id="why-do-i-want-it">Why do I want it?</h2>
<p>Modern cloud infrastructure has become an engineering field in and of itself, with a high learning curve and limited
hiring pool. Unfortunately, good cloud infrastructure is also required by software products if one wishes it to
be highly available and scalable. While there are platform-as-a-service (PaaS) products in the market offering to
handle the complexity of the cloud providers, running customer applications in their simplified cloud, these products
replace the old problems with new ones. By having a middleman between them and the servers, customers will naturally
have higher infrastructure prices (that&rsquo;s how middleman businesses work), which grow and become more severe as they
scale. Debugging will become more difficult by the same principles. Most importantly of all, the customers will be
surrendering ownership and control of their infrastructure, meaning:</p>
<ul>
<li>Difficult integration with custom resources even if the PaaS' underlying cloud provider has it.</li>
<li>Added delay of release of new features/version from the underlying cloud provider.</li>
<li>Inheriting deficiencies of the new layer with limited abilities to configure and remediate</li>
<li>Inheritance of security vulnerabilities.</li>
</ul>
<p>Opta provides an alternative model by deploying and maintaining resources directly in the cloud provider and under the
customers own account, while yet offering an opinionated framework taking care of default settings and &ldquo;golden path&rdquo;
resource integrations automatically. Required infrastructure knowledge is kept to a minimum while the customer reaps
the benefits of &ldquo;directly&rdquo; managing their cloud resources.</p>
<h3 id="what-is-it-good-for">What is it good for?</h3>
<p>Opta was designed with the following use cases in mind:</p>
<ul>
<li>A young startup seeking to quickly create reliable and scalable infrastructure while keeping their engineers
focused on the app.</li>
<li>A mature business seeking to move legacy infrastructure to the cloud.</li>
</ul>
<h2 id="where-should-i-go-next">Where should I go next?</h2>
<p>Read the <a href="/docs/getting-started/">Getting Started Guide</a> or check out some <a href="/docs/examples/">Examples</a>.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-93aadc1aba179e6928539400a09b9e4e">2 - Getting Started</h1>
    <div class="lead">The first steps in working with Opta.</div>
	<h2 id="installation">Installation</h2>
<p>Check out the <a href="/docs/installation">Installation instructions</a>.</p>
<p>Make sure, your AWS credentials are configured in the terminal for the AWS account you will use in this exercise.</p>
<h2 id="environment-creation">Environment creation</h2>
<p>In this step we will create an environment (example staging, qa, prod) for your organization.
For this we need to create an <code>opta.yml</code> file which defines the environment.</p>
<p>Create the following file at <code>staging/opta.yml</code> and update the fields specific to your AWS/GCP account setup.
<nav>
	<div class="nav nav-tabs" id="nav-tab" role="tablist">

		
		

		
		
		

		

		<a class="nav-item nav-link active" id="nav-1" data-toggle="tab" href="#tab11" role="tab"
		   aria-controls="nav-home" aria-selected="true">AWS</a>

		
		

		
		
		

		

		<a class="nav-item nav-link" id="nav-1" data-toggle="tab" href="#tab12" role="tab"
		   aria-controls="nav-home" aria-selected="false">GCP</a>

		
		

	</div>
</nav>

<div class="tab-content" id="1">








<div class="tab-pane fade show active" id="tab11" role="tabpanel" aria-labelledby="nav-tabName1">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Add your own name/org_name -- the name + org_name must be universally unique</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">aws</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">account_id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XXXX</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-dns</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.mydomain.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">delegated</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-eks</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_instance_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t3.medium </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max_nodes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>









<div class="tab-pane fade" id="tab12" role="tabpanel" aria-labelledby="nav-tabName2">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Add your own name/org_name -- the name + org_name must be universally unique</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">google</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-central1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">project</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XXX</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-dns</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.mydomain.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">subdomains</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Need to specify supported subdomains individually for GCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">app </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">delegated</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-gke</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">node_instance_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;n2-highcpu-4&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max_nodes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>





</div>
Now, cd to the <code>staging</code> dir and run:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta apply
</code></pre></div><p>This step will create an EKS cluster for you and set up VPC, networking and various other infrastructure pieces transparently.</p>
<p><em>Note: while we create the &ldquo;domain&rdquo;, setting it up so that it actually receives internet traffic and has ssl takes some extra
steps, please check out the <a href="/docs/tutorials/ingress">Ingress docs</a>.</em></p>
<h2 id="service-creation">Service creation</h2>
<p>In this step we will create a service with your application&rsquo;s logic.
We will create another <code>opta.yml</code> file, which defines high level configuration of this service.</p>
<p>Create an <code>opta.yml</code> and update the fields specific to your service setup.
<nav>
	<div class="nav nav-tabs" id="nav-tab" role="tablist">

		
		

		
		
		

		

		<a class="nav-item nav-link active" id="nav-2" data-toggle="tab" href="#tab21" role="tab"
		   aria-controls="nav-home" aria-selected="true">AWS</a>

		
		

		
		
		

		

		<a class="nav-item nav-link" id="nav-2" data-toggle="tab" href="#tab22" role="tab"
		   aria-controls="nav-home" aria-selected="false">GCP</a>

		
		

	</div>
</nav>

<div class="tab-content" id="2">








<div class="tab-pane fade show active" id="tab21" role="tabpanel" aria-labelledby="nav-tabName1">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-world</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environments</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;staging/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">min_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">max_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">public_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;app.{parent.domain}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resource_request</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in millicores</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">512</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in megabytes</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">min_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{vars.min_containers}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{vars.max_containers}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># autoscales to this limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">healthcheck_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/get&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">env_vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APPENV</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{env}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">links</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">db</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">secrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Checkout the secrets tutorial on how to use these</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">API_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>









<div class="tab-pane fade" id="tab22" role="tabpanel" aria-labelledby="nav-tabName2">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">environments</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;staging/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">variables</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">max_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello-world</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">public_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;app.{parent.domain}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resource_request</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in millicores</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">512</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in megabytes</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">min_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{vars.min_containers}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max_containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{vars.max_containers}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># autoscales to this limit</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">healthcheck_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/get&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">env_vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APPENV</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{env}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">links</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">db</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">secrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Checkout the secrets tutorial on how to use these</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">API_KEY</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">db</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>





</div></p>
<p>Now you are ready to deploy your service.</p>
<h2 id="service-deployment">Service Deployment</h2>
<p>In the example above, we have created all the resources for the environment but haven&rsquo;t yet created the resources for the service. We also haven&rsquo;t deployed your container to the service. Both of these things happens in a single next step.
To deploy, we need to first build the image, push it, and then apply
the yaml again, this time specifying the now existing remote image and tag. You can do so by following these steps to
deploy the service:</p>
<ul>
<li>Build docker image: <code>docker build -t test-service:v1 ...</code> set v1 to what you want to call this version. Usually the git sha. In this example you can pull an existing image and retag it</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker pull kennethreitz/httpbin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> docker tag kennethreitz/httpbin:latest test-service:v1
</code></pre></div><ul>
<li>Deploy:</li>
</ul>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta deploy --image test-service:v1
</code></pre></div><p>Now, once this step is complete, you should be to curl your service by specifying the url of the load balancer we
created for you (again, can&rsquo;t use the domain until you finish the extra ingress steps outlined in the tutorial, but
you can totally hit the load balancer directly) and setting the host header to match your desired domain:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta configure-kubectl
<span style="color:#204a87">export</span> <span style="color:#000">DOMAIN</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>kubectl get services -n ingress-nginx ingress-nginx-controller --output <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{.status.loadBalancer.ingress[0].hostname}&#39;</span><span style="color:#4e9a06">`</span>
curl --header <span style="color:#4e9a06">&#34;Host: app.staging.mydomain.com&#34;</span>  http://<span style="color:#4e9a06">${</span><span style="color:#000">DOMAIN</span><span style="color:#4e9a06">}</span>/get
</code></pre></div><ul>
<li>To fully setup the public dns and ssl, please checkout the <a href="/docs/tutorials/ingress">Ingress docs</a>.</li>
<li>Run <code>opta</code> to check various other options the cli provides, like streaming logs, or ssh into your container.</li>
</ul>
<h2 id="cleanup">Cleanup</h2>
<p>Once you&rsquo;re finished playing around with these examples, you may clean up by running the following command from the environment directory:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta destroy
</code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6121397c9c1b82e0a74996f89313317c">3 - Installation</h1>
    <div class="lead">Installation Instructions</div>
	<h2 id="prerequisites">Prerequisites</h2>
<p>Opta currently has the following system prerequisites to operate normally:</p>
<ul>
<li>A supported macos or debian distro release.</li>
<li><a href="https://www.terraform.io/downloads.html">terraform</a> (v0.14+)</li>
<li><a href="https://docker.com/products/docker-desktop">docker</a> (v19+)</li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> (also packaged with
docker-for-mac)</li>
<li><a href="https://cloud.google.com/sdk/docs/install">GCP SDK</a> (For GCP only)</li>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">AWS CLI</a> (v2) (For AWS only)</li>
</ul>
<h2 id="macos-or-linux">MacOS or Linux</h2>
<p>Run this script to install the latest version of opta (see below for changelog
and release history).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/bin/bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://docs.runx.dev/install.sh<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</code></pre></div><p>You can specify a particular version as well.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000">VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span>0.x /bin/bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://docs.runx.dev/install.sh<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</code></pre></div><h2 id="releases">Releases</h2>
<h3 id="01116">0.11.16</h3>
<ul>
<li>Added support for multiple public_uri</li>
</ul>
<h3 id="01110">0.11.10</h3>
<ul>
<li>Added support for GCP!</li>
</ul>
<h3 id="0119">0.11.9</h3>
<ul>
<li>AWS Nodegroup module added</li>
</ul>
<h3 id="0118">0.11.8</h3>
<h4 id="changelog">Changelog</h4>
<ul>
<li>Fix for when tf.state is empty</li>
</ul>
<h3 id="0117">0.11.7</h3>
<ul>
<li>Added release automation</li>
</ul>
<h3 id="0116">0.11.6</h3>
<ul>
<li>Removed buggy rollback from cli</li>
</ul>
<h3 id="0115">0.11.5</h3>
<h4 id="changelog-1">Changelog</h4>
<ul>
<li>Fixing the terraform init issue with envs</li>
<li>fixing tests</li>
</ul>
<h3 id="0114">0.11.4</h3>
<ul>
<li>Pin linkerd version to avoid automatic updates</li>
<li>Schema validation bug fixes</li>
</ul>
<hr>
<h3 id="0112">0.11.2</h3>
<ul>
<li>Container logs and k8s events are streamed to shell during deploys</li>
<li>10x faster CLI by reducing calls to terraform init</li>
<li>opta validate</li>
<li>opta deploy sets up infra and deploys in one go</li>
</ul>
<h4 id="changelog-2">Changelog</h4>
<ul>
<li>opta deploy, opta logs and opta shell</li>
<li>Bugfixes</li>
</ul>
<hr>
<h3 id="010">0.10</h3>
<h4 id="changelog-3">Changelog</h4>
<ul>
<li>opta deploy, opta logs and opta shell</li>
<li>Bugfixes</li>
</ul>
<hr>
<h3 id="09">0.9</h3>
<h4 id="changelog-4">Changelog</h4>
<ul>
<li>Revamped the Opta API</li>
<li>Implemented opta inspect</li>
<li>Bugfixes</li>
</ul>
<hr>
<h3 id="07">0.7</h3>
<h4 id="changelog-5">Changelog</h4>
<ul>
<li>Introduced org_id in env yaml files</li>
<li>Bugfixes</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/32dfe0ae4cc0f61dc6ad34bed69932cf05af0538">32dfe0a</a></p>
<hr>
<h3 id="06">0.6</h3>
<h4 id="changelog-6">Changelog</h4>
<ul>
<li>Added support for websockets</li>
<li>Updated port syntax (BREAKING CHANGE)</li>
<li>Bunch of bugfixes!</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/8dec38d34d72eb82dd46e2f5f423b627e50d5729">8dec38d</a></p>
<hr>
<h3 id="05">0.5</h3>
<h4 id="changelog-7">Changelog</h4>
<ul>
<li>Added opta configure-kubectl</li>
<li>Updated link syntax (BREAKING CHANGE)</li>
<li>Bugfix for deleting/renaming resources</li>
<li>Bugfix for deleting rds/docdb</li>
<li>Added opta push</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/85185d87719e5f86219d47d35b5872d4a5dc237a">85185d8</a></p>
<hr>
<h3 id="04">0.4</h3>
<h4 id="changelog-8">Changelog</h4>
<ul>
<li>Added opta secret list</li>
<li>Added opta output</li>
<li>Added support for document db</li>
<li>Bugfix for redis</li>
<li>Misc cleanup</li>
<li>zip packaging for faster runtime!</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/0a60153da5d2756ccc3220ab346f8ba276357deb">0a60153</a></p>
<hr>
<h3 id="03">0.3</h3>
<h4 id="changelog-9">Changelog</h4>
<ul>
<li>No changes in opta but the binaries are generated by an automated mechanism</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/163fb775ce31c1c45568ba3de1e04447e23da59c">163fb77</a></p>
<hr>
<h3 id="02">0.2</h3>
<h4 id="changelog-10">Changelog</h4>
<ul>
<li>Added tests</li>
<li>Added sentry and amplitude</li>
<li>Added support for multiple environments</li>
<li>Added support for s3</li>
<li>Added support for elastic cache</li>
<li>Misc stability and bug fixes</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/dcd6a83bd8737ad3f0b4a22455d94fc8dc4fbd86">dcd6a83</a></p>
<hr>
<h3 id="01">0.1</h3>
<h4 id="changelog-11">Changelog</h4>
<ul>
<li>First release!</li>
</ul>
<p>Github: <a href="https://github.com/run-x/runxc/commit/ff53aad6a0a3b86cffb9e21b3112fd7b29b26e65">ff53aad</a></p>
<hr>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8dbd4e302cd86a4d0f71f71ce3b300de">4 - Tutorials</h1>
    <div class="lead">Tutorials on Opta</div>
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f107a9a5510ab74922b9a96e5ca94e5e">4.1 - Continuous Deployment</h1>
    <div class="lead">Instructions to integrate with the CI/CD platform of your choice</div>
	<h2 id="github-action">Github Action</h2>
<p>If you are using Github Actions for your CI, you can use the <a href="https://github.com/run-x/deploy-action"><code>run-x/deploy-action</code></a> action. This action will push your local docker image up to a remote registry and then deploy that image.</p>
<h3 id="authentication">Authentication</h3>
<p>In order for the deploy action to execute properly, you will need to use other github actions for authentication.</p>
<ol>
<li><a href="https://github.com/run-x/webfactory/ssh-agent"><code>webfactory/ssh-agent</code></a>, to allow access to other repositories' opta configuration files. Note that you only need to use this if you have opta.yml files in other repos.</li>
<li><a href="https://github.com/run-x/aws-actions/configure-aws-credentials"><code>aws-actions/configure-aws-credentials</code></a>, to allow push and deploy to AWS. Make sure that the API key associated with this account has admin permissions.</li>
</ol>
<h3 id="example">Example</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CI-CD</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">push</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">branches</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">main]</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pull_request</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">branches</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">main]</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">jobs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">opta-deploy-staging</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">runs-on</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ubuntu-latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">steps</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Checkout repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">uses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">actions/checkout@v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># You only need to include this step if you have opta files outside of this repo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Setup ssh</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">uses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webfactory/ssh-agent@v0.4.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># if you don&#39;t have a github SSH key, you can generate one here: </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># https://docs.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ssh-private-key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${{ secrets.GITHUB_SSH_KEY }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Configure AWS credentials	</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">uses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-actions/configure-aws-credentials@v1	</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">with:	</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># This aws account should have admin permissions</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">aws-access-key-id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${{ secrets.AWS_ACCESS_KEY }}	</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">aws-secret-access-key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${{ secrets.AWS_SECRET_ACCESS_KEY }}	</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">aws-region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1	</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Build image</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">run</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker build -t app:latest -f Dockerfile .</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Update deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Note that this version should be the same as your CLI version</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">uses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">run-x/deploy-action@v0.11.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">tag</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${{ github.sha }}</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83887ce2e0d6dbc08b4950ccb6e53c2c">4.2 - Datadog Integration</h1>
    <div class="lead">Instructions on how to integrate your environment with Datadog</div>
	<p>Opta provides deep integration with <a href="https://www.datadoghq.com/">Datadog</a>.</p>
<p>With this integration you can have:</p>
<ul>
<li>Metrics on both the whole cluster (e.g. how many servers are we running? How much cpu/memory are
they using? How many containers does each have?).</li>
<li>Metrics on the individual app (e.g. how much memory/cpu are our containers
running? How often are they dying).</li>
<li>Custom metrics endpoint</li>
<li>Events tracking changes in your environment (e.g. service x has just deployed new version).</li>
<li>Application performance metrics.</li>
<li>Log storage/forwarding from your containers.</li>
</ul>
<p>To enable Datadog integration, all you gotta do is add it in your environment opta yaml like so:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">aws</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">account_id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XXXX</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-dns</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-eks</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datadog</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Yes, just one line! Same for GCP!</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Run <code>opta apply</code> once more, where opta will prompt you to add your datadog key (only the first time, it&rsquo;s securely stored
for successive runs). Logs, APM and custom metric envars will be setup and ready to use on all your application containers. Every piece of data coming from the environment will be
tagged with <code>env</code> set to the layer name, and service deployments will have a <code>service</code> tag set to its layer name and
<code>version</code> set to the image tag used.</p>
<p>For a high level view of your cluster, you can view your kubernetes dashboards on the following url:
<a href="https://app.datadoghq.com/screen/integration/86/kubernetes-overview">https://app.datadoghq.com/screen/integration/86/kubernetes-overview</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5b96ef224df2cb76031f57bc78e2a4e2">4.3 - Debugging</h1>
    <div class="lead">How to debug your app</div>
	<blockquote>
<p>Ideally, you should set up <a href="/docs/tutorials/observability">observability</a> so that manual debugging is not needed.</p>
</blockquote>
<p>Opta provides 2 helpful commands to help with debugging:</p>
<h3 id="view-logs">View logs</h3>
<pre><code>opta logs
</code></pre><p>This will show you logs from all your app instances.</p>
<h3 id="ssh-into-an-instance">SSH into an instance</h3>
<pre><code>opta shell
</code></pre><p>This will open up a shell into one of your app instances.</p>
<h3 id="kubectl">Kubectl</h3>
<p>Opta uses kubernetes under the hood, so we recommend using the standard
kubernetes tool <code>kubectl</code> for most debugging use cases. This page will give you
a brief tutorial on how to use this tool.</p>
<h3 id="install-kubectl">Install kubectl</h3>
<p>On mac, you can install it via:</p>
<pre><code>brew install kubectl
</code></pre><p>More detailed instructions are available on the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">offical site</a></p>
<h3 id="configure-kubectl">Configure kubectl</h3>
<p>Before you can use <code>kubectl</code>, you need to connect it to your kubernetes cluster
(created by opta). This is pretty simple in the opta world! Just run:</p>
<pre><code>  opta configure-kubectl
</code></pre><h3 id="view-pods">View pods</h3>
<blockquote>
<p>Kubernetes uses the word &ldquo;pod&rdquo; for containers[^1]. So every service will have one or more pods (as specified in your opta yml).</p>
</blockquote>
<p>You can see the pods for a given service by running:</p>
<pre><code>kubectl get pods -n &lt;service-name&gt;
</code></pre><blockquote>
<p>If this doesn&rsquo;t show any pods, that means your service hasn&rsquo;t been deployed. Check out the <a href="/docs/getting-started/#service-deployment">deployment docs</a> to fix that.</p>
</blockquote>
<p>Note that <code>&lt;service-name&gt;</code> is specified in your opta yml:</p>
<pre><code>  meta:
    name: blah # service-name
  modules:
    app: # module-name
      type: k8s-service
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9d0b9641c9f6229bb5bedf0bcd2431a9">4.4 - IAM Guidance</h1>
    <div class="lead">How to configure your iam to work with Opta</div>
	<h1 id="overview">Overview</h1>
<p>Identity access management, IAM, is how a user can control permissions to read and/or modify resources in their
cloud accounts. When opta runs, it uses your currently configured credentials for your role/user of your cloud provider
to read your state, and update/create resources as needed. Due to the large amount and variety of resources opta
is responsible for, we recommend folks to use a role/user with account admin privileges for opta, but we hope to
begin providing more specific policies in the future. Furthermore, the k8s cluster needs authentication and
authorization to read and write resources to itself, which is tied to the cloud provider&rsquo;s IAM. Below, we go over the
specifics for the setup for each cloud.</p>
<h1 id="aws">AWS</h1>
<p>When creating a new AWS account, there are two routes you can go by</p>
<ol>
<li>Create and link accounts with <a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_tutorials_basic.html">AWS Organizations</a>
and then use <a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html">AWS SSO</a> (yes, there are other SSO
options, but we won&rsquo;t cover those).</li>
<li>Create separate AWS accounts the old-fashioned way.</li>
</ol>
<p>We recommend using the AWS Organization route as, although it&rsquo;s a little extra setup, will make your life way easier when
scaling to multiple environments and accounts and AWS accounts themselves don&rsquo;t cost anything so fiscal prudence is not
a problem. Nonetheless, here are the instructions for both routes.</p>
<h2 id="org--sso">Org + SSO</h2>
<p>For this approach, you will need a &ldquo;root account&rdquo; to start with, which you can create via the traditional method. As
the creator, you will be bestowed with admin privileges. From there you can follow the official steps <a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_tutorials_basic.html">here</a>
to setup your organization&ndash; you&rsquo;ll want to focus on the &ldquo;Create a member account&rdquo; section, and don&rsquo;t worry about the
organizational units or service control policies for now.</p>
<p>Once that&rsquo;s setup, we can create SSO for your Organization by going to the root AWS account and following the official
<a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/step1.html">steps</a>. You&rsquo;ll want to focus on steps 1, 2, and
3 for now, and for step 2 if you&rsquo;re using gsuite, go ahead and use that as your source by following <a href="https://aws.amazon.com/blogs/security/how-to-use-g-suite-as-external-identity-provider-aws-sso/">this</a>.
Once that&rsquo;s settled, you can <a href="https://docs.aws.amazon.com/singlesignon/latest/userguide/useraccess.html#assignusers">assign user access</a>
to the different accounts in your organization. For opta usage, we recommend to use the SSO Admin access/permission set.</p>
<p><em>NOTE</em> If you want to deploy opta in the root account (which we advise against), feel free to use the New Account section
instructions from down below</p>
<h2 id="new-account">New Account</h2>
<p>Outside of SSO, if one were to use opta then you have to create a new IAM for opta which your human teammates
could then &ldquo;<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use.html">assume</a>&rdquo;. This assumption allows IAM
users (and other roles too) to get credentials for the assumed role (time limited) and interact with the AWS API on their
behalf. <em>This way many people can get the same permissions and act as the same entity without compromising their own
personal credentials</em>. For role assumption, two things are required:</p>
<ol>
<li>The role to be assumed must have its trust policy include the role that would assume it (explicitly or through a group).
<img src="/images/iam_tutorial_image_1.png" alt="image alt text"></li>
<li>The assumer role/user must have the IAM permission to assume the opta role.
<img src="/images/iam_tutorial_image_2.png" alt="image alt text"></li>
</ol>
<p>To create such a role and permission, you can start by following the official IAM role creation instructions
<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html#roles-creatingrole-user-console">here</a>.
When prompted &ldquo;Specify accounts that can use this role&rdquo; add the own account id. This satisfies requirement 1 as now
the role will be ok with ANY IAM role/user in your account to assume it (you can refine the list later). Continue and
give it the Administrator Access policy (should be one of the first on the list), and create it (you can add tags if you
so wish). Now you have a role capable of executing AWS requests with admin privileges.
<img src="/images/iam_tutorial_image_3.png" alt="image alt text"></p>
<p>To satisfy requirement 2, all you have to do is follow this <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_permissions-to-switch.html">guide</a>
for all the IAM users/roles you have in question. You can then test it out by running the following with you current credentials:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">aws sts assume-role --role-arn <span style="color:#4e9a06">&#34;THE_OPTA_ROLE_ARN&#34;</span> --role-session-name DUMMY_SESSION
</code></pre></div><p>The output should be the temporary credentials to assume the opta role. Just set the envars as so:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">export</span> <span style="color:#000">AWS_ACCESS_KEY_ID</span><span style="color:#ce5c00;font-weight:bold">=</span>RoleAccessKeyID
<span style="color:#204a87">export</span> <span style="color:#000">AWS_SECRET_ACCESS_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span>RoleSecretKey
<span style="color:#204a87">export</span> <span style="color:#000">AWS_SESSION_TOKEN</span><span style="color:#ce5c00;font-weight:bold">=</span>RoleSessionToken
</code></pre></div><p>You can now run opta and any other AWS cli/sdk with the opta role.</p>
<h3 id="cross-account-access">Cross Account Access</h3>
<p>If you want to give a user access to run opta in account a while their IAM role/user is in account b, simply refine
the opta role you created in account a to allow role assumption from account b (again, you can further specify which
iam users/roles are) and make sure that you allowed role assumption in the assumer to the new account.</p>
<h3 id="long-term-credentials">Long Term Credentials</h3>
<p>For long term credentials (e.g. to hardcode into a CI system), we recommend you create an IAM user who can then assume
the role used by opta and using its credentials, assuming the opta role as part of the process.</p>
<h1 id="gcp">GCP</h1>
<h2 id="basic-management-architecture">Basic management architecture</h2>
<p>In GCP, Google has created a distinct IAM/project/org flow which may seems backwards from the AWS model. Due to Google&rsquo;s
wide array of business products, GCP is often tightly integrated, as shall be explained:</p>
<p>Usage of GCP begins by first <a href="https://cloud.google.com/resource-manager/docs/creating-managing-organization">creating the organization</a>
under which all projects (equivalent to AWS accounts) would be created. This is done through either a <a href="https://support.google.com/a/answer/53926">Google Workspace</a>
(formerly called G Suite the same workspace used to setup your company&rsquo;s gmail, Google Calendar, Google Drive, etc&hellip;)
or a <a href="https://cloud.google.com/identity">Cloud Identy</a> (we advise to choose the Google Workspace). The first project
is created automatically upon signing in to GCP for the first time, although you can easily spin up many more as the need
arises, and can even bundle them into folders. Runx currently recommends 1 project per environment.</p>
<p><img src="/images/gcp-org.png" alt="image alt text"></p>
<p>You will, however, need to create at least one <a href="https://cloud.google.com/billing/docs/concepts">billing account</a> and
link it to the project before using any service. A billing account is how payment for GCP is handled, and they exist
as separate entities from the project (under the hood they link to a <a href="https://support.google.com/paymentscenter/topic/9017382?ref_topic=9037778">google payments profile</a>
but most users should not be concerned about this). An organization can have multiple billing accounts which can in turn
be linked to multiple projects to handle their payments (a project can only have 1 linked billing account). In this manner
can a company use different/the same budgets for different projects, and add restrictions or perform analysis as needed.</p>
<p><img src="/images/gcp-billing.png" alt="image alt text"></p>
<p><a href="https://cloud.google.com/iam/docs/overview#concepts_related_identity">IAM for humans</a> can similarly be handled by google
accounts setup in your google workspace/cloud identity, but also private google accounts or Google Groups (again, we
recommend using the workspace). These identities exist outside GCP, so are global to all orgs and can be given
access at the org level, project level, or folder level. As such, cross-account/project access doesn&rsquo;t really apply
and one just needs to ensure they have the desired permissions on the different projects in mind.</p>
<h3 id="opta-usage">Opta usage</h3>
<p>Once a project is setup with a correct billing account, opta only needs to run as a project owner for the given
project (in time opta will create a refined role so the full owner scope is not needed). You can do this by running:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gcloud auth application-default login
</code></pre></div><h3 id="long-term-credentials-1">Long Term Credentials</h3>
<p>Long term credentials can be generated by creating a service account (akin to AWS IAM roles) with the required permissions
and <a href="https://cloud.google.com/docs/authentication/production#create_service_account">generating service account keys for it</a>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fc48c3d786e14f954240ac60661342b3">4.5 - Ingress</h1>
    <div class="lead">How to expose your app on the internet</div>
	<h3 id="setting-the-domain-for-an-environment">Setting the domain for an Environment</h3>
<p>With opta, you can specify a domain for each environment which can be used by all the services running in that
environment. This is done with the aws-dns/gcp-dns module like so:
<nav>
	<div class="nav nav-tabs" id="nav-tab" role="tablist">

		
		

		
		
		

		

		<a class="nav-item nav-link active" id="nav-1" data-toggle="tab" href="#tab11" role="tab"
		   aria-controls="nav-home" aria-selected="true">AWS</a>

		
		

		
		
		

		

		<a class="nav-item nav-link" id="nav-1" data-toggle="tab" href="#tab12" role="tab"
		   aria-controls="nav-home" aria-selected="false">GCP</a>

		
		

	</div>
</nav>

<div class="tab-content" id="1">








<div class="tab-pane fade show active" id="tab11" role="tabpanel" aria-labelledby="nav-tabName1">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">aws</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">account_id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XXXX</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-dns</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;-- this entry</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.startup.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-eks</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>









<div class="tab-pane fade" id="tab12" role="tabpanel" aria-labelledby="nav-tabName2">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">google</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-central1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">project</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jds-throwaway-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-dns</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;-- this entry</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">subdomains</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">myapp </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">delegated</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-gke</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>





</div></p>
<p>As is, the aws-dns/gcp-dns will create the &ldquo;hosted zone&rdquo; resource which manages your dns rules
for the domain you listed. In order for it to receive public traffic and get ssl
(to have https instead of http connections), you have to do some extra setup which
<em>proves</em> that you own it.</p>
<p>This extra setup is updating the domain&rsquo;s nameservers to point to your opta environment&rsquo;s AWS/GCP &ldquo;hosted zone&rdquo;. This is how you do it:</p>
<ul>
<li>Run <code>opta apply</code> on the yaml file at least once to create the underlying resources</li>
<li>Run <code>opta output</code> and note down the nameservers that get printed. It&rsquo;s usually a set of 4 servers.</li>
<li>Assuming you own example.com and want to map staging.example.com to this environment. Then you&rsquo;d add the following NS records in your domain registrar, where ns1-ns4 are the nameservers from the previous step.
<pre><code>staging				1h			ns1
staging				1h			ns2
staging				1h			ns3
staging				1h			ns4
</code></pre></li>
</ul>
<p>It will take a few minutes for this change to sync with the internet, so just go and grab some coffee for 10 minutes.</p>
<p>You can verify that you did this properly by running this command:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">dig staging.startup.com NS
</code></pre></div><p>You should see your name servers under the <code>ANSWER SECTION</code> part.</p>
<p>Once this is done and verified, please update your opta yaml aws-dns/gcp-dns section to have a new field <code>delegated: true</code> like
so:
<nav>
	<div class="nav nav-tabs" id="nav-tab" role="tablist">

		
		

		
		
		

		

		<a class="nav-item nav-link active" id="nav-2" data-toggle="tab" href="#tab21" role="tab"
		   aria-controls="nav-home" aria-selected="true">AWS</a>

		
		

		
		
		

		

		<a class="nav-item nav-link" id="nav-2" data-toggle="tab" href="#tab22" role="tab"
		   aria-controls="nav-home" aria-selected="false">GCP</a>

		
		

	</div>
</nav>

<div class="tab-content" id="2">








<div class="tab-pane fade show active" id="tab21" role="tabpanel" aria-labelledby="nav-tabName1">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">aws</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-east-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">account_id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">XXXX</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-dns</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.startup.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">delegated</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;-- THIS</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-eks</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>









<div class="tab-pane fade" id="tab22" role="tabpanel" aria-labelledby="nav-tabName2">

	<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">org_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">runx</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">providers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">google</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">region</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">us-central1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">project</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jds-throwaway-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-dns</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">subdomains</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">myapp </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">delegated</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &lt;-- THIS</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-gke</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcp-k8s-base</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>

</div>





</div></p>
<p>Now run <code>opta apply</code> one more time and opta will now generate your ssl certificates and attach them. Congratulations,
your environment will now be picking up public traffic on your domain and have https!</p>
<h3 id="exposing-a-service">Exposing a service</h3>
<p>A service can be exposed on a subdomain of the environment domain or on a path via the public_uri field.</p>
<h4 id="exposing-on-a-subdomain">Exposing on a subdomain</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myapp </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">envs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;staging/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">myapp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">public_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;myapp.{parent.domain}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Following the domain examples above, this will expose the service at <a href="https://myapp.staging.startup.com">https://myapp.staging.startup.com</a></p>
<h4 id="exposing-on-a-path">Exposing on a path</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myapp </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">envs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;staging/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">myapp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">public_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{parent.domain}/myapp&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Following the domain examples above, this will expose the service at <a href="https://staging.startup.com/myapp">https://staging.startup.com/myapp</a></p>
<h3 id="combine-both">Combine both</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myapp </span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">envs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;staging/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">myapp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">public_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;myapp.{parent.domain}/v1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Following the domain examples above, this will expose the service at <a href="https://myapp.staging.startup.com/v1">https://myapp.staging.startup.com/v1</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-10de6b7200433cebbfbebcaa1583a5c0">4.6 - Secrets</h1>
    <div class="lead">Creating secrets for your application</div>
	<p>Opta provides in-built secret management for your applications. Any secrets like database passwords, api keys, should not be written in the code (including opta.yml) because if the code is leaked accidentally, your infrastructure is exposed to hackers. Hence we store these secrets in a specific secret store. To use the secrets functionality:</p>
<ul>
<li>Define the secrets in the service&rsquo;s opta.yml file.</li>
<li>Use the <code>opta secret</code> cli to update the value and list secrets.</li>
</ul>
<ol>
<li>You can define/provision all the secrets you would need for an application in the service&rsquo;s opta.yml file like this:</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">my_app</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environments</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;staging/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">my_app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">target_port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">tag</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{tag}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">env_vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">ENV</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{parent[name]}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">secrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">MY_SECRET_1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">MY_SECRET_2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>So when you run <code>opta apply</code> on this file, it will provision the secrets for you.</p>
<ol start="2">
<li>Now you can use the following command (from the dir where above file is located) to list all your secrets</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta secret list my_app --env staging
</code></pre></div><ol start="3">
<li>To set the values of the secrets, you can use the cli</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta secret update my_app MY_SECRET_1 SECRET_VALUE --env staging
</code></pre></div><p>Note: The secret needs to be set individually for each service and environment</p>
<ol start="4">
<li>You can print the value of an existing secret with the cli</li>
</ol>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opta secret view my_app MY_SECRET_1 --env staging
</code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bec94d1629f08bf2950648ea6d1cd59d">5 - Modues reference</h1>
    <div class="lead">Opta config reference</div>
	<h1 id="whats-an-opta-module">What&rsquo;s an Opta module?</h1>
<p>The heart of Opta is a set of &ldquo;Modules&rdquo; which basically map to AWS resources that
need to get created. Opta yamls reference these under the <code>modules</code> field.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myapp</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environments</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;../env/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This is an instance of the k8-service module type called app</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">public_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;app.{parent.domain}/app&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resource_request</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in millicores</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">512</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in megabytes</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">healthcheck_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/get&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">env_vars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENV</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{env}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">links</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">rds</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">redis</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rds</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This is an instance of the aws-rds module type called mydatabase</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This is an instance of the aws-redis module type called myredis</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-redis</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>You&rsquo;ll note that the module instance can have user-specified names which will come into play later with references.
Opta modules are composed of the following entities/behaviors:</p>
<h2 id="fields">Fields</h2>
<p>You&rsquo;ll note that there can be many, varying, fields per module instance such
as &ldquo;type&rdquo;, &ldquo;env_vars&rdquo;, &ldquo;image&rdquo; etc&hellip;  These are called <em>fields</em> and this
is how specific data is passed into the modules.</p>
<h3 id="names">Names</h3>
<p>All modules have a name field, which is used to create the name of the cloud resources in conjunction with the layer
name (root name of opta.yml). A user can specify this with the <code>name</code> field, but it defaults to the module type (without
the hyphens) if not given.</p>
<h3 id="types">Types</h3>
<p>All modules have their own list of supported fields, but the one common to all is <em>type</em>. The type field is simply
the module reference (e.g. the library/package to use in this &ldquo;import&rdquo;). Opta currently comes with its list of valid
modules built in &ndash; future work may allow users to specify their own.</p>
<h3 id="linking">Linking</h3>
<p>The k8s-service module type is the first (but not the last) module to support
special processing. In this case, it&rsquo;s in regard to the <em>links</em> field. The
links field takes as input a list of maps with a single element where the
key is the name of another module in the file, and the value a list of
strings representing resource permissions.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myapp</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">environments</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">staging</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">parent</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;../env/opta.yml&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">modules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This is an instance of the k8-service module type called app</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">.</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">links</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">rds</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">redis</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">docdb</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">bucket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">write</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rds</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This is an instance of the aws-rds module type called database</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-postgres</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># This is an instance of the aws-redis module type called redis</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-redis</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docdb</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-documentdb</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bucket</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">aws-s3</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">bucket_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;test-bucket&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9dfe91c9afb5ff49c25d4272db6709a">5.1 - Environment modules</h1>
    
	<p>This section provides the list of module types for the user to use in an environment opta yaml (a root one with no environments on top specified), with their inputs and outputs.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8b65a7f9c654579631b4e0819aa048df">5.1.1 - AWS environment modules</h1>
    
	<h2 id="aws-base">aws-base</h2>
<p>This module is the &ldquo;base&rdquo; module for creating an environment in aws. It sets up the VPCs, default kms key and the
db/cache subnets. Defaults are set to work 99% of the time, assuming no funny networking constraints (you&rsquo;ll know them
if you have them), so <em>no need to set any of the fields or know what the outputs do</em>.</p>
<p><em>Fields</em></p>
<ul>
<li><code>total_ipv4_cidr_block</code> &ndash; Optional. This is the total cidr block for the VPC. Defaults to &ldquo;10.0.0.0/16&rdquo;</li>
<li><code>private_ipv4_cidr_blocks</code> &ndash; Optional. These are the cidr blocks to use for the private subnets, one for each AZ.
Defaults to [&ldquo;10.0.128.0/21&rdquo;, &ldquo;10.0.136.0/21&rdquo;, &ldquo;10.0.144.0/21&rdquo;]</li>
<li><code>public_ipv4_cidr_blocks</code> &ndash; Optional. These are the cidr blocks to use for the public subnets, one for each AZ.
Defaults to [&ldquo;10.0.0.0/21&rdquo;, &ldquo;10.0.8.0/21&rdquo;, &ldquo;10.0.16.0/21&rdquo;]</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li><code>kms_account_key_arn</code> &ndash; The <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html">ARN</a> of the default
<a href="https://aws.amazon.com/kms/">KMS</a> key (this is what handles encryption for redis, documentdb, eks, etc&hellip;)</li>
<li><code>kms_account_key_id</code> &ndash; The <a href="https://docs.aws.amazon.com/kms/latest/developerguide/find-cmk-id-arn.html">ID</a> of the default
KMS key (sometimes things need the ID, sometimes the ARN, so we&rsquo;re giving both)</li>
<li><code>vpc_id</code> &ndash; The ID of the <a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html">VPC</a> we created for
this environment</li>
<li><code>private_subnet_ids</code> &ndash; The IDs of the private <a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html">subnets</a>
we setup for your environment</li>
<li><code>public_subnets_ids</code> &ndash; The IDs of the public <a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html">subnets</a>
we setup for your environment</li>
</ul>
<h2 id="aws-dns">aws-dns</h2>
<p>This module creates a <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-working-with.html">Route53 hosted zone</a> for
your given domain. The <a href="#k8s-base">k8s-base</a> module automatically hooks up the load balancer to it
for the domain and subdomain specified, but in order for this to actually receive traffic you will need to complete
the <a href="/docs/tutorials/ingress">dns setup</a>.</p>
<p><em>Fields</em></p>
<ul>
<li>domain &ndash; Required. The domain you want (you will also get the subdomains for your use)</li>
<li>delegated &ndash; Optional. Set to true once the extra dns setup is complete.</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li>zone_id &ndash; The ID of the hosted zone created</li>
<li>name_servers &ndash; The name servers of your hosted zone (very important for the dns setup)</li>
<li>domain &ndash; The domain again</li>
<li>cert_arn &ndash; The arn of the <a href="https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html">ACM certificate </a> which
is used for ssl.</li>
</ul>
<h2 id="aws-eks">aws-eks</h2>
<p>This module creates an <a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html">EKS cluster</a>, and a default
nodegroup to host your applications in. This needs to be added in the environment opta yml if you wish to deploy services
as opta services run on Kubernetes.</p>
<p><em>Fields</em></p>
<ul>
<li><code>min_nodes</code> &ndash; Optional. The minimum number of nodes to be set by the autoscaler in for the default nodegroup. Defaults to 3.</li>
<li><code>max_nodes</code> &ndash; Optional. The minimum number of nodes to be set by the autoscaler in for the default nodegroup. Defaults to 5.</li>
<li><code>node_disk_size</code> &ndash; Optional. The size of disk to give the nodes' ec2s. Defaults to 20(GB)</li>
<li><code>node_instance_type</code> &ndash; Optional. The <a href="https://aws.amazon.com/ec2/instance-types/">ec2 instance type</a> for the nodes. Defaults
to t3.medium (highly unrecommended to set to smaller)</li>
<li><code>k8s_version</code> &ndash; Optional. The Kubernetes version for the cluster. Must be <a href="https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html">supported by EKS</a></li>
</ul>
<h2 id="k8s-base">k8s-base</h2>
<p>This module is responsible for all the base infrastructure we package into the opta K8s environments. This includes:</p>
<ul>
<li><a href="https://github.com/kubernetes/autoscaler">Autoscaler</a> for scaling up and down the ec2s as needed</li>
<li><a href="https://github.com/kubernetes-sigs/external-dns">External DNS</a> to automatically hook up the ingress to the hosted zone and its domain</li>
<li><a href="https://github.com/kubernetes/ingress-nginx">Ingress Nginx</a> to expose services to the public</li>
<li><a href="https://github.com/kubernetes-sigs/metrics-server">Metrics server</a> for scaling different deployments based on cpu/memory usage</li>
<li><a href="https://linkerd.io/">Linkerd</a> as our service mesh.</li>
</ul>
<p><em>Fields</em>
None for the user, we allow no configuration at the time.</p>
<p><em>Outputs</em>
None</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b02d26f6c20395131bdf4246898f743a">5.1.2 - GCP environment modules</h1>
    
	<h2 id="gcp-base">gcp-base</h2>
<p>This module is the &ldquo;base&rdquo; module for creating an environment in gcp. It sets up the VPC, private subnet, firewall,
default kms key, private service access, and activate the container registry. Defaults are set to work 99% of the time, assuming no funny
networking constraints (you&rsquo;ll know them if you have them), so <em>no need to set any of the fields or know what the outputs do</em>.</p>
<p><em>Fields</em></p>
<ul>
<li><code>private_ipv4_cidr_block</code> &ndash; Optional. This is the cidr block for VM instances in the VPC. Defaults to &ldquo;10.0.0.0/19&rdquo;</li>
<li><code>cluster_ipv4_cidr_block</code> &ndash; Optional. This is the cidr block reserved for pod ips in the GKE cluster. Defaults to &ldquo;10.0.32.0/19&rdquo;</li>
<li><code>services_ipv4_cidr_block</code> &ndash; Optional This is the cidr block reserved for service cluster ips in the GKE cluster. Defaults to &ldquo;10.0.64.0/20&rdquo;</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li>kms_account_key_id &ndash; The id of the <a href="https://cloud.google.com/security-key-management">KMS</a> key (this is what handles
encryption for redis, gke, etc&hellip;)</li>
<li>kms_account_key_self_link &ndash; The self link of the default
KMS key (sometimes things need the ID, sometimes the ARN, so we&rsquo;re giving both)</li>
<li>vpc_id &ndash; The ID of the <a href="https://cloud.google.com/vpc/docs/vpc">VPC</a> we created for this environment</li>
<li>private_subnet_id &ndash; The ID of the private <a href="https://cloud.google.com/vpc/docs/vpc#subnet-ranges">subnets</a>
we setup for your environment</li>
</ul>
<h2 id="gcp-dns">gcp-dns</h2>
<p>This module creates a GCP <a href="https://cloud.google.com/dns/docs/zones">managed zone</a> for
your given domain. The <a href="#k8s-base">k8s-base</a> module automatically hooks up the load balancer to it
for the domain and subdomain specified, but in order for this to actually receive traffic you will need to complete
the <a href="/docs/tutorials/ingress">dns setup</a>.</p>
<p><em>Fields</em></p>
<ul>
<li>domain &ndash; Required. The domain you want (you will also get the subdomains for your use)</li>
<li>delegated &ndash; Optional. Set to true once the extra dns setup is complete and it will add the ssl certs.</li>
<li>subdomains &ndash; Optional. A list of subdomains to also get ssl certs for.</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li>zone_id &ndash; The ID of the hosted zone created</li>
<li>name_servers &ndash; The name servers of your hosted zone (very important for the dns setup)</li>
<li>domain &ndash; The domain again</li>
<li>cert_arn &ndash; The arn of the <a href="https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html">ACM certificate </a> which
is used for ssl.</li>
</ul>
<h2 id="gcp-gke">gcp-gke</h2>
<p>This module creates an <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview">GKE cluster</a>, and a default
node pool to host your applications in. This needs to be added in the environment opta yml if you wish to deploy services
as opta services run on Kubernetes.</p>
<p><em>Fields</em></p>
<ul>
<li><code>min_nodes</code> &ndash; Optional. The minimum number of nodes to be set by the autoscaler in for the default nodegroup. Defaults to 3.</li>
<li><code>max_nodes</code> &ndash; Optional. The minimum number of nodes to be set by the autoscaler in for the default nodegroup. Defaults to 5.</li>
<li><code>node_disk_size</code> &ndash; Optional. The size of disk to give the nodes' ec2s. Defaults to 20(GB)</li>
<li><code>node_instance_type</code> &ndash; Optional. The <a href="https://cloud.google.com/compute/docs/machine-types">gcloud machine type</a> for the nodes. Defaults
to n2-highcpu-4 (highly unrecommended to set to smaller)</li>
<li><code>gke_channel</code> &ndash; Optional. The GKE K8s <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels">release channel</a>
to bind the cluster too. Gives you automatic K8s version management for the lcuster and node pools. Defaults to &ldquo;REGULAR&rdquo;</li>
</ul>
<h2 id="gcp-k8s-base">gcp-k8s-base</h2>
<p>This module is responsible for all the base infrastructure we package into the opta K8s environments. This includes:</p>
<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx">Ingress Nginx</a> to expose services to the public</li>
<li><a href="https://linkerd.io/">Linkerd</a> as our service mesh.</li>
<li>A custom load balancer and dns routing built to handle the Ingress Nginx which we set up.
<em>Fields</em>
None for the user, we allow no configuration at the time.</li>
</ul>
<p><em>Outputs</em>
None</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3525fa571dc1c25f855af7e3f2060b89">5.1.3 - Cloud agnostic environment modules</h1>
    
	<h2 id="datadog">datadog</h2>
<p>This module setups the <a href="https://docs.datadoghq.com/agent/kubernetes/?tab=helm">Datadog Kubernetes</a> integration onto
the EKS cluster created for this environment. Please read the <a href="/docs/tutorials/datadog">datadog tutorial</a> for all the
details of the features.</p>
<p><em>Fields</em>
None. It&rsquo;ll prompt the use for a valid api key the first time it&rsquo;s run, but nothing else, and nothing in the yaml.</p>
<p><em>Outputs</em>
None</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-17f62f7e9a70bad68895e6447344b83a">5.2 - Service modules</h1>
    
	<p>This section provides the list of module types for the user to use in an service opta yaml (referencing one or more environments), with their inputs and outputs.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d13b5dc21fdb391688377e7ca5945001">5.2.1 - AWS service modules</h1>
    
	<h2 id="aws-documentdb">aws-documentdb</h2>
<p>This module creates an AWS Documentdb  cluster. It is made in the private subnets automatically created for the environment.
macro and so can only be accessed in the VPC or through some proxy (e.g. VPN). It is encrypted
at rest with a kms key created in the env setup and in transit via tls.</p>
<p><em>Fields</em></p>
<ul>
<li><code>instance_class</code> &ndash; Optional. This is the RDS instance type used for the documentdb cluster <a href="https://aws.amazon.com/documentdb/pricing/">instances</a>.
Default db.r5.large</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a k8s-service, this adds connection credentials to your container&rsquo;s environment variables as:</p>
<ul>
<li><code>{module_name}_db_user</code></li>
<li><code>{module_name}_db_password</code></li>
<li><code>{module_name}_db_host</code></li>
</ul>
<p>In the above example file, the <em>{module_name}</em> would be replaced with <code>docdb</code></p>
<p>In addition to these credentials, you also need to enable SSL encryption when
connecting (<a href="https://docs.aws.amazon.com/documentdb/latest/developerguide/connect_programmatically.html">AWS docs</a>).
Fortunately, the Opta k8s-service module has already taken care of that. On linking, you&rsquo;ll
find the AWS CA at <code>/config/rds_ca.pem</code></p>
<p>As an example, this is how the mongoose/node connection looks like:</p>
<pre><code>await mongoose.connect(&quot;mongodb://&lt;USER&gt;:&lt;PASSWORD&gt;@&lt;HOST&gt;, {
  ssl: true,
  sslCA: require('fs').readFileSync(`/config/rds_ca.pem`)
});
</code></pre><h2 id="aws-postgres">aws-postgres</h2>
<p>This module creates a postgres Aurora RDS database instance. It is made in the
private subnets automatically created during environment setup and so can only be accessed in the
VPC or through some proxy (e.g. VPN).</p>
<p><em>Fields</em></p>
<ul>
<li><code>instance_class</code> &ndash; Optional. This is the RDS instance type used for the Aurora cluster <a href="https://aws.amazon.com/rds/instance-types/">instances</a>.
Default db.r5.large</li>
<li><code>engine_version</code> &ndash; Optional. The version of the database to use. Default 11.9.</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a k8s-service, it adds connection credentials to your container&rsquo;s environment variables as:</p>
<ul>
<li><code>{module_name}_db_user</code></li>
<li><code>{module_name}_db_password</code></li>
<li><code>{module_name}_db_name</code></li>
<li><code>{module_name}_db_host</code></li>
</ul>
<p>In the above example file, the <em>{module_name}</em> would be replaced with <code>rds</code></p>
<p>The permission list is to be empty because we currently do not support giving
apps IAM permissions to manipulate a database.</p>
<h2 id="aws-redis">aws-redis</h2>
<p>This module creates a redis cache via elasticache. It is made with one failover instance across azs, and is encrypted
at rest with a kms key created in the env setup via the <em>init</em> macro and in transit via tls. It is made in the private
subnets created by the _init macro and so can only be accessed in the VPC or through some proxy (e.g. VPN).</p>
<p><em>Fields</em></p>
<ul>
<li><code>node_type</code> &ndash; Optional. This is the redis instance type used for the <a href="https://aws.amazon.com/elasticache/pricing/">instances</a>.
Default cache.m4.large.</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a k8s-service, it adds connection credentials to your container&rsquo;s environment variables</p>
<ul>
<li><code>{module_name}_cache_auth_token</code> &ndash; The auth token/password of the cluster.</li>
<li><code>{module_name}_cache_host</code> &ndash; The host to contact to access the cluster.</li>
</ul>
<p>In the above example file, the <em>{module_name}</em> would be replaced with <code>redis</code></p>
<p><em>NOTE</em> Redis CLI will not work against this cluster because redis cli does not
support the TLS transit encryption. There should be no trouble with any of the
language sdks however, as they all support TLS.</p>
<h2 id="aws-s3">aws-s3</h2>
<p>This module creates an S3 bucket for storage purposes. It is created with server-side AES256 encryption.</p>
<p><em>Fields</em></p>
<ul>
<li><code>bucket_name</code>&ndash; Required. The name of the bucket to create.</li>
<li><code>block_public</code> &ndash; Optional. Block all public access. Default true</li>
<li><code>bucket_policy</code> &ndash; Optional. A custom s3 policy json/yaml to add.</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li><code>bucket_id</code> &ndash; The id/name of the bucket.</li>
<li><code>bucket_arn</code> &ndash; The arn of the bucket.</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a k8s-service, this adds the necessary IAM permissions to read
(e.g. list objects and get objects) and/or write (e.g. list, get,
create, destroy, and update objects) to the given s3 bucket.
The current permissions are, &ldquo;read&rdquo; and &ldquo;write&rdquo;. These need to be
specified when you add the link.</p>
<h2 id="k8s-service">k8s-service</h2>
<p>The most important module for deploying apps, k8s-service deploys a kubernetes app.
It deploys your service as a rolling update securely and with simple autoscaling right off the bat&ndash; you
can even expose it to the world, complete with load balancing both internally and externally.</p>
<p><em>Fields</em></p>
<ul>
<li><code>port</code> &ndash; Required. Specifies what port your app was made to be listened to. Currently it must be a map of the form
<code>http: [PORT_NUMBER_HERE]</code> or <code>tcp: [PORT_NUMBER_HERE]</code>. Use http if you just have a vanilla http server and tcp for
websockets.</li>
<li><code>min_containers</code> &ndash; Optional. The minimum number of replicas your app can autoscale to. Default 1</li>
<li><code>max_containers</code> &ndash; Optional. The maximum number of replicas your app can autoscale to. Default 3</li>
<li><code>image</code> &ndash; Required. Set to AUTO to create a private repo for your own images. Otherwises attempts to pull image from public dockerhub</li>
<li><code>env_vars</code> &ndash; Optional. A list of maps holding name+value fields for envars to add to your container
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FLAG</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div></li>
<li><code>secrets</code> &ndash; Optional. Same format as env_vars, but these values will be stored in the secrets resource, not directly
in the pod spec.</li>
<li><code>autoscaling_target_cpu_percentage</code> &ndash;  Optional. See the <a href="#autoscaling">autoscaling</a> section. Default 80</li>
<li><code>autoscaling_target_mem_percentage</code> &ndash; Optional. See the <a href="#autoscaling">autoscaling</a> section. Default 80</li>
<li><code>healthcheck_path</code> &ndash; Optional. See the See the <a href="#livenessreadiness-probe">liveness/readiness</a> section. Default &ldquo;/healthcheck&rdquo;</li>
<li><code>resource_request</code> &ndash; Optional. See the <a href="#container-resources">container resources</a> section. Default
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in millicores</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in megabytes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>CPU is given in millicores, and Memory is in megabytes.</p>
</li>
<li><code>public_uri</code> &ndash; Optional. The full domain to expose your app under as well as path prefix. Must be the full parent domain or a subdomain referencing the parent as such: &ldquo;dummy.{parent[domain]}/my/path/prefix&rdquo;</li>
<li><code>additional_iam_roles</code> &ndash; Optional. A list of extra IAM role arns not captured by Opta which you wish to give to your service.</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li><code>docker_repo_url</code> &ndash; The url of the docker repo created to host this app&rsquo;s images in this environment. Does not exist
when using external images.</li>
</ul>
<h4 id="externalinternal-image">External/Internal Image</h4>
<p>Furthermore, this module supports deploying from an &ldquo;external&rdquo; image repository (currently only public ones supported)
by setting the <code>image</code> field to the repo (e.g. &ldquo;kennethreitz/httpbin&rdquo; in the examples). If you set the value to &ldquo;AUTO&rdquo; however,
it will automatically create a secure container repository with ECR on your account. You can then use the <code>opta push</code>
command to push to it!</p>
<h4 id="healthcheck-probe">Healthcheck Probe</h4>
<p>One of the benefits of K8s is that it comes with built in checks for the responsiveness of your server. These are called
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/"><em>liveness</em> and <em>readiness</em> probes</a>.</p>
<p>tl;dr A liveness probe determines whether your server should be restarted, and readiness probe determines if traffic should
be sent to a replica or be temporarily rerouted to other replicas. Essentially smart healthchecks. Opta requires the
user to have such health check endpoints for all http apps (a hello world get endpoint would do) but for websockets it
just checks the tcp connection on the given port.</p>
<h4 id="autoscaling">Autoscaling</h4>
<p>As mentioned, autoscaling is available out of the box. We currently only support autoscaling
based on the pod&rsquo;s cpu and memory usage, but we hope to soon offer the ability to use 3rd party metrics like datadog
to scale. As mentioned in the k8s docs, the horizontal pod autoscaler (which is what we use) assumes a linear relationship between # of replicas
and cpu (twice the replicas means half expected cpu usage), which works well assuming low overhead.
The autoscaler then uses this logic to try and balance the cpu/memory usage at the percentage of request. So, for example,
if the target memory is 80% and we requested 100mb, then it&rsquo;ll try to keep the memory usage at 80mb. If it finds that
the average memory usage was 160mb, it would logically try to double the number of replicas.</p>
<h4 id="container-resources">Container Resources</h4>
<p>One of the other benefits of kubernetes is that a user can have fine control over the <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">resources used by each of their containers</a>.
A user can control the cpu, memory and disk usage with which scheduling is made, and the max limit after which the container is killed.
With Opta, we expose such settings to the user, while keeping sensible defaults.</p>
<p><em>NOTE</em> We expose the resource requests and set the limits to twice the request values.</p>
<h4 id="ingress">Ingress</h4>
<p>You can control if and how you want to expose your app to the world! Check out
the <a href="/docs/tutorials/ingress">Ingress</a> docs for more details.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f95dcc211c00d06f7f821a5c6acfcf1">5.2.2 - GCP service modules</h1>
    
	<h2 id="gcp-gcs">gcp-gcs</h2>
<p>This module creates an gcs bucket for storage purposes. It is created with encryption based on the default kms key
created for you in the base, as well as the standard AES-256 encryption.</p>
<p><em>Fields</em></p>
<ul>
<li><code>bucket_name</code>&ndash; Required. The name of the bucket to create.</li>
<li><code>block_public</code> &ndash; Optional. Block all public access. Default true</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li><code>bucket_id</code> &ndash; The id of the bucket.</li>
<li><code>bucket_name</code> &ndash; The name of the bucket.</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a gcp-k8s-service, this adds the necessary IAM permissions to read
(e.g. list objects and get objects) and/or write (e.g. list, get,
create, destroy, and update objects) to the given gcs bucket.
The current permissions are, &ldquo;read&rdquo; and &ldquo;write&rdquo;. These need to be
specified when you add the link.</p>
<h2 id="gcp-postgres">gcp-postgres</h2>
<p>This module creates a postgres <a href="https://cloud.google.com/sql/docs/introduction">GCP Cloud SQL</a> database. It is made with
the <a href="https://cloud.google.com/vpc/docs/private-services-access">private service access</a>, ensuring private communication.</p>
<p><em>Fields</em></p>
<ul>
<li><code>instance_tier</code> &ndash; Optional. This is the RDS instance type used for the cloud sql instance <a href="https://cloud.google.com/sql/pricing">instances</a>.
Default &ldquo;db-f1-micro&rdquo;</li>
<li><code>engine_version</code> &ndash; Optional. The major version of the database to use. Default 11</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a k8s-service, it adds connection credentials to your container&rsquo;s environment variables as:</p>
<ul>
<li><code>{module_name}_db_user</code></li>
<li><code>{module_name}_db_password</code></li>
<li><code>{module_name}_db_name</code></li>
<li><code>{module_name}_db_host</code></li>
</ul>
<p>In the above example file, the <em>{module_name}</em> would be replaced with <code>rds</code></p>
<p>The permission list is to be empty because we currently do not support giving
apps IAM permissions to manipulate a database.</p>
<h2 id="gcp-redis">gcp-redis</h2>
<p>This module creates a redis cache via <a href="https://cloud.google.com/memorystore/docs/redis/redis-overview">Memorystore</a>.
It is made with their standard high availability offering, but (unlike in AWS) there is no
<a href="https://stackoverflow.com/questions/58032778/gcp-cloud-memorystore-data-encryption-at-rest">encryption at rest</a>
and in-transit encryption is not offered as terraform support is in beta. It is made in the with private service access
ensuring private communication.</p>
<p><em>Fields</em></p>
<ul>
<li><code>node_type</code> &ndash; Optional. This is the redis instance type used for the <a href="https://aws.amazon.com/elasticache/pricing/">instances</a>.
Default cache.m4.large.</li>
<li><code>redis_version</code> - the Memorystore offered redis version to use. Default REDIS_5_0</li>
</ul>
<p><em>Linking</em></p>
<p>When linked to a k8s-service, it adds connection credentials to your container&rsquo;s environment variables</p>
<ul>
<li><code>{module_name}_cache_auth_token</code> &ndash; The auth token/password of the cluster.</li>
<li><code>{module_name}_cache_host</code> &ndash; The host to contact to access the cluster.</li>
</ul>
<p>In the above example file, the <em>{module_name}</em> would be replaced with <code>redis</code></p>
<h2 id="gcp-k8s-service">gcp-k8s-service</h2>
<p>The most important module for deploying apps, gcp-k8s-service deploys a kubernetes app on gcp.
It deploys your service as a rolling update securely and with simple autoscaling right off the bat&ndash; you
can even expose it to the world, complete with load balancing both internally and externally.</p>
<p><em>Note</em>: This is nigh-identical to the original AWS version, save that (due to the new IAM method) it is not possible to pass in
IAM permissions at the moment. This will be addressed in accordance to need from users.</p>
<p><em>Fields</em></p>
<ul>
<li><code>port</code> &ndash; Required. Specifies what port your app was made to be listened to. Currently it must be a map of the form
<code>http: [PORT_NUMBER_HERE]</code> or <code>tcp: [PORT_NUMBER_HERE]</code>. Use http if you just have a vanilla http server and tcp for
websockets.</li>
<li><code>min_containers</code> &ndash; Optional. The minimum number of replicas your app can autoscale to. Default 1</li>
<li><code>max_containers</code> &ndash; Optional. The maximum number of replicas your app can autoscale to. Default 3</li>
<li><code>image</code> &ndash; Required. Set to AUTO to create a private repo for your own images. Otherwises attempts to pull image from public dockerhub</li>
<li><code>env_vars</code> &ndash; Optional. A list of maps holding name+value fields for envars to add to your container
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FLAG</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div></li>
<li><code>secrets</code> &ndash; Optional. Same format as env_vars, but these values will be stored in the secrets resource, not directly
in the pod spec.</li>
<li><code>autoscaling_target_cpu_percentage</code> &ndash;  Optional. See the <a href="#autoscaling">autoscaling</a> section. Default 80</li>
<li><code>autoscaling_target_mem_percentage</code> &ndash; Optional. See the <a href="#autoscaling">autoscaling</a> section. Default 80</li>
<li><code>healthcheck_path</code> &ndash; Optional. See the See the <a href="#livenessreadiness-probe">liveness/readiness</a> section. Default &ldquo;/healthcheck&rdquo;</li>
<li><code>resource_request</code> &ndash; Optional. See the <a href="#container-resources">container resources</a> section. Default
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in millicores</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">128</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># in megabytes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>CPU is given in millicores, and Memory is in megabytes.</p>
</li>
<li><code>public_uri</code> &ndash; Optional. The full domain to expose your app under as well as path prefix. Must be the full parent domain or a subdomain referencing the parent as such: &ldquo;dummy.{parent[domain]}/my/path/prefix&rdquo;</li>
</ul>
<p><em>Outputs</em></p>
<ul>
<li><code>docker_repo_url</code> &ndash; The url of the docker repo created to host this app&rsquo;s images in this environment. Does not exist
when using external images.</li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-23695faee9f53cc21616fd61b8186a04">6 - Architecture</h1>
    <div class="lead">An overview of the Architecture Opta sets up.</div>
	<p>The core principle of Opta is to not have our users compromise between cost, UX and implementation. To that end, Opta
sets up a sophisticated, yet robust, architecture for your services and environments behind the scenes. This
architecture can be broken up between resources in the base cloud provider (e.g. AWS, GCP), and internal to the
kubernetes clusters we deploy. Below are the specifications and answers for the common security questions.</p>
<h2 id="aws">AWS</h2>
<p><img src="/images/opta_aws_architecture.png" alt="image alt text">
For AWS our environments are currently setup within a single region, but our networking is set up across 3 availability
zones by default, split between a private and public subnet (which we provision as we do not use the default vpc).
The public subnet is solely used for the public load balancer, while the ec2s (VMs) and databases all exist within
the private subnet.</p>
<p>We deploy the EKS cluster with one nodegroup spanning all the private subnets created. The current EKS cluster version
is 1.18, but this can be manually overridden if needed (and we get security patches as needed automatically via EKS).
Currently, there is a public cluster endpoint, but this may be revisited once a story for VPN support is planned out.
<a href="https://aws.amazon.com/blogs/containers/using-eks-encryption-provider-support-for-defense-in-depth/">Encryption for the secrets is also provided via KMS</a>.</p>
<p>For databases, we currently have modules for postgres (AWS Aurora), redis (AWS Elasticache), and the mongodb compatible
documentdb (AWS Documentdb). We only offer 1 instance per db (no read or write replicas), but we hope to add this
feature as customers demand. The postgres and documentdb databases are built with 5 day retention of backups in case of
emergency. The username and passwords are created with the database and are passed securely to the K8s services as
secrets (pls see K8s section for security around secrets).</p>
<p>There also is a module for S3 storage, which creates a private bucket by default (but can be set to public via fields)
and all the buckets are encrypted at rest with AES 256 regardless.</p>
<p>Lastly, DNS and SSL are currently handled via one Route53 hosted zone and one ACM certificate respectively. ACM cert
verification is done with Route53 record manipulation in the given hosted zone. Records will be added to the hosted
zone directing to the load balancer via an open source integration (see K8s section).</p>
<h3 id="security-concerns">Security Concerns</h3>
<ul>
<li>All databases and ec2s are run within the private subnets (i.e. can access the internet via a nat gateway, but
nothing external can reach them).</li>
<li>All databases (redis, documentdb, sql) are encrypted at rest with a KMS key provisioned by the environment.</li>
<li>All database connections use SSL encryption.</li>
<li>All S3 buckets are encrypted with AES 256.</li>
<li>All networking access is managed via security groups either auto-provisioned by EKS, or manually crafted to just
expose to the VPC and just the ports required for standard usage (i.e. 5432 for postgres).</li>
<li>The EKS node ec2s are created with just the AmazonEKSClusterPolicy</li>
<li>The EKS storage (e.g. K8s secrets) is encrypted at rest via KMS</li>
<li>K8s service accounts are mapped to IAM roles via the officially sanctioned <a href="https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html">OIDC</a>
manner, with no long-lived credentials.</li>
<li>No long-lived IAM credentials are ever created.</li>
<li>All ECR images/repos are private to the account.</li>
<li>S3 buckets created privately by default.</li>
<li>5 day backup retentions for the postgres/documentdb databases.</li>
<li>Currently, the EKS cluster is built with a public endpoint for the simple usage (can add private option later on once
VPN feature is added).</li>
</ul>
<h2 id="gcp">GCP</h2>
<p><em>Coming soon!</em></p>
<h2 id="k8s">K8s</h2>
<p><img src="/images/opta_internal_kubernetes_architecture.png" alt="image alt text"></p>
<p>The K8s topology is divided into namespaces of 2 types: 3rd party integrations and opta services. The third party
integrations consist of respected open source projects which handle background tasks or features expansions. These
currently consist of:</p>
<p><em>Note</em>: GCP does an awesome job in support K8s and actually includes several of the following integrations/features by
default. Watch for the notes at the end of each description.</p>
<p><a href="https://linkerd.io/">Linkerd</a>: Linkerd is the second most popular service mesh currently out there (right behind
Istio) and is the one we provide for our users. We chose it over Istio due to its absurdly simple maintenance and
upgrade stories while still offering the vast majority of the important service mesh features (e.g. traffic control,
grpc+http load balancing, mTLS, golden metrics). Linkerd also takes pride in its security and has undergone intense
security audits. The typical opta user should not even see it.</p>
<p><a href="https://github.com/kubernetes-sigs/metrics-server">Metrics Server</a>: The official metric server, distributed separately
for EKS (comes with GKE) and used to power the standard horizontal pod autoscaler metrics (e.g. automatically scale up
or scale down your server as needed for current load). <em>Builtin on GKE</em></p>
<p><a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Cluster Autoscaler</a>: The official node
autoscaler, distributed separately for EKS (comes with GKE) and used to add/remove underlying machines (e.g. ec2s of
compute instances) serving as the nodes. <em>Builtin on GKE</em></p>
<p><a href="https://kubernetes.github.io/ingress-nginx/">Ingress Nginx</a>: An official ingress (i.e. how to expose the cluster to
the outside world) which uses a fleet of nginx containers to route incoming traffic from a load balancer to inside the
cluster and a desired service. <em>Not used on GKE</em></p>
<p><a href="https://github.com/kubernetes-sigs/external-dns">External DNS</a>: An official project used to automatically add DNS
records for load balancers created by the cluster.</p>
<p><a href="https://github.com/DataDog/helm-charts/tree/master/charts/datadog">Datadog</a>: The official K8s integration for Datadog
which sends cluster metrics + events and container logs over to your datadog account. We also configure it to accept
any custom metrics or apm automatically by using their official client libraries. This integration is not part of the
opta K8s base, but most be added separately w/ the Datadog K8s module.</p>
<p>All of these additions (as well as the Opta services), are managed via <a href="https://helm.sh/">Helm Charts</a> (using V3), and
are deployed separately to their own namespace.</p>
<p>Opta services are also deployed to unique namespaces formed out of their layer name (base name on the opta yaml&ndash; there
should never be more than one k8s service per opta yaml). Each opta service consists of one K8s service, deployment (and
its affiliated pods), horizontal pod autoscaler, configmap, service account, and optionally an ingress if they so wish
to expose their opta service&rsquo;s api to the public. The deployment manages the different pods (e.g. containers/servers)
of your application while the K8s service is used with Linkerd to route cluster-internal traffic&ndash; as is, any service
can be contacted via a domain of the form MODULE_NAME.LAYERNAME, such as app.hello-world for the Getting Started example. The horizontal pod
autoscaler is responsible for increasing/decreasing the number of pods of the deployment as needed based on cpu ad memory
usage. The service account ties the deployment to a given cloud IAM AWS role/GCP service account to get any permissions
for cloud resources (e.g. GCS/S3 access). There are no further K8s roles added to the service account meaning that
one Opta service will not be able to manipulate the K8s resources for another. The secret (always encrypted at rest) is
used for sensitive custom data, as well as database access credentials. Lastly, we have a configmap (for EKS) which
currently holds the latest public key needed for documentdb usage.</p>
<h3 id="security-concerns-1">Security Concerns</h3>
<ul>
<li><a href="https://github.com/linkerd/linkerd2/blob/main/SECURITY_AUDIT.pdf">Here is Linkerd&rsquo;s security audit</a></li>
<li>All cross-service communication is encrypted via mTLS</li>
<li>All 3rd party charts used are the official ones when applicable or provided by bitnami and version-locked.</li>
<li>All IAM roles for 3rd party charts are endowed with just the required permissions for their roles following the
principle of least privilege.</li>
<li>All opta service deployments are bound to service accounts, with no extra K8s roles.</li>
<li>Opta currently does not modify the aws-auth configmap for EKS.</li>
<li>We use Helm V3</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User support list" aria-label="User support list">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="support@runx.dev">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener noreferrer" href="https://join.slack.com/share/zt-m55nvh0w-8V7HAqdHKHEUAU40K2h~BQ">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 RunX Labs Inc. All Rights Reserved</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>











<script src="/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js" integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin="anonymous"></script>



<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
        apiKey: '45a325ff63b40a0ee70998f1049e20c3',
        indexName: 'runx',
        inputSelector: '.td-search-input',
        debug: false 
    });
</script>



  </body>
</html>
